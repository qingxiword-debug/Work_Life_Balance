Æ’<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Work-Life Balance v5.0</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-body: #fbf9f6; --surface: #ffffff;
            --primary: #a89080; --primary-dark: #6d5b50;
            --text-main: #4a403a; --text-sub: #9e948d; --line: #f0ebe5;
            --tag-ot: #f5f0eb; --tag-ot-text: #8c7b70;
            --tag-off: #edf2ed; --tag-off-text: #6b8c6e;
            --radius: 20px; --shadow: 0 4px 24px rgba(168, 144, 128, 0.08);
            
            --card-sl-bg: #fff0f0; --card-sl-icon: #e17070;
            --card-al-bg: #eaf6f6; --card-al-icon: #5daaaa;
            --card-ot-bg: #fff6e6; --card-ot-icon: #e6a23c;
            --card-cl-bg: #f3eefc; --card-cl-icon: #9b7fe6;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: "Hiragino Sans", "PingFang TC", sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* LOGIN SCREEN */
        #loginScreen { position: fixed; inset: 0; background: var(--bg-body); z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; transition: opacity 0.5s; }
        .login-box { background: white; padding: 30px; border-radius: 24px; box-shadow: var(--shadow); width: 100%; max-width: 320px; text-align: center; }
        .login-title { font-size: 1.5rem; font-weight: 800; color: var(--primary-dark); margin-bottom: 20px; }
        
        header { padding: 12px 20px; padding-top: max(12px, env(safe-area-inset-top)); display: flex; justify-content: space-between; align-items: center; background: var(--bg-body); z-index:10; }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 800; color: var(--primary-dark); letter-spacing: 0.5px; display:flex; align-items:center; gap:8px;}
        .ver-tag { font-size:0.7rem; background:#eee; padding:2px 6px; border-radius:6px; color:#888; font-weight:normal;}
        .status-dot { width:8px; height:8px; border-radius:50%; background:#ccc; transition:0.3s; }
        .status-dot.online { background:#22c55e; box-shadow:0 0 5px #22c55e; }
        .status-dot.offline { background:#ef4444; }
        .header-actions { display: flex; gap: 15px; align-items: center; }
        .btn-icon { background: none; border: none; font-size: 1.2rem; color: var(--primary); cursor: pointer; padding: 5px; position: relative; }
        #dateJumper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        main { flex: 1; overflow-y: auto; padding: 0 16px 100px 16px; opacity: 0; transition: opacity 0.5s; } /* Hidden by default until login */

        .big-cal-wrapper { background: var(--surface); border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow); margin-bottom: 15px; }
        .bc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .bc-title { font-weight: 800; font-size: 1rem; color: var(--primary-dark); }
        .bc-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; }
        .bc-head { font-size: 0.7rem; color: var(--text-sub); margin-bottom: 2px; font-weight: 600; }
        .bc-day { height: 38px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; font-size: 0.9rem; cursor: pointer; position: relative; transition: 0.2s; color: var(--text-main); }
        .bc-day.other-month { color: #eee; pointer-events: none; }
        .bc-day.today { background: var(--primary); color: white; }
        .bc-day.selected { border: 2px solid var(--primary); }
        .bc-dots { display: flex; gap: 2px; position: absolute; bottom: 3px; }
        .dot { width: 3px; height: 3px; border-radius: 50%; }
        .dot.holiday { background-color: #ef4444; }
        .dot.record { background-color: #8c7b70; }
        .bc-day.today .dot { background-color: white; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat-card { background: var(--surface); border-radius: var(--radius); padding: 14px; box-shadow: var(--shadow); display: flex; flex-direction: column; justify-content: space-between; height: 130px; position: relative; overflow: hidden; }
        .sc-icon-box { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; margin-bottom: 8px; }
        .sc-title { font-size: 0.8rem; font-weight: 700; color: var(--text-main); }
        .sc-val-row { display: flex; align-items: baseline; gap: 4px; margin-top: auto; }
        .sc-val { font-size: 1.5rem; font-weight: 800; color: var(--text-main); }
        .sc-unit { font-size: 0.75rem; color: var(--text-sub); }
        .progress-container { margin-top: 8px; height: 4px; background: #f0f0f0; border-radius: 2px; width: 100%; overflow: hidden; }
        .progress-bar { height: 100%; border-radius: 2px; }
        .sc-sub { font-size: 0.65rem; color: var(--text-sub); margin-top: 4px; display: flex; justify-content: space-between; }
        .card-sl .sc-icon-box { background: var(--card-sl-bg); color: var(--card-sl-icon); } .card-sl .progress-bar { background: var(--card-sl-icon); }
        .card-al .sc-icon-box { background: var(--card-al-bg); color: var(--card-al-icon); } .card-al .progress-bar { background: var(--card-al-icon); }
        .card-ot .sc-icon-box { background: var(--card-ot-bg); color: var(--card-ot-icon); }
        .card-cl .sc-icon-box { background: var(--card-cl-bg); color: var(--card-cl-icon); } .card-cl .progress-bar { background: var(--card-cl-icon); }

        .chart-section { background: var(--surface); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); margin-bottom: 15px; border: 1px solid var(--line); }
        .chart-header { font-size: 0.95rem; font-weight: 700; color: var(--primary-dark); margin-bottom: 15px; }
        .chart-wrap { position: relative; height: 200px; width: 100%; }

        .day-header { display: flex; justify-content: space-between; align-items: baseline; margin: 5px 5px 10px 5px; }
        .dh-title { font-size: 1rem; font-weight: 700; color: var(--primary-dark); }
        .dh-badge { font-size: 0.75rem; padding: 3px 8px; border-radius: 6px; }
        .badge-work { background: #fff7ed; color: #c2410c; }
        .badge-off { background: #f0fdf4; color: #15803d; }
        .badge-hol { background: #fef2f2; color: #b91c1c; }

        .log-item { display: flex; align-items: center; padding: 14px; background: var(--surface); border-radius: 16px; margin-bottom: 10px; border: 1px solid var(--line); box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .log-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 1rem; }
        .icon-ot { background: var(--tag-ot); color: var(--tag-ot-text); }
        .icon-leave { background: var(--tag-off); color: var(--tag-off-text); }
        .log-main { flex: 1; }
        .log-title { font-weight: 700; font-size: 0.95rem; color: var(--text-main); }
        .log-date { font-size: 0.75rem; color: var(--text-sub); margin-top: 2px; }
        .log-val { font-weight: 700; color: var(--primary-dark); font-size: 1rem;}

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; visibility: hidden; opacity: 0; transition: opacity 0.3s; display: block; }
        .modal-overlay.open { visibility: visible; opacity: 1; }
        .modal-card { position: absolute; bottom: 0; left: 0; right: 0; background: var(--surface); border-radius: 30px 30px 0 0; padding: 30px 24px 50px 24px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); max-height: 90vh; overflow-y: auto; }
        .modal-overlay.open .modal-card { transform: translateY(0); }

        .form-label { font-size: 0.85rem; font-weight: 700; color: var(--text-sub); margin: 15px 0 8px 0; display: block; }
        .form-input { width: 100%; padding: 14px; border: 2px solid var(--line); background: #faf9f7; border-radius: 14px; font-size: 1rem; color: var(--text-main); -webkit-appearance: none; }
        .btn { width: 100%; padding: 15px; border-radius: 14px; border: none; font-weight: 700; font-size: 1rem; margin-top: 20px; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--primary-dark); color: white; box-shadow: 0 4px 12px rgba(94, 80, 70, 0.2); }
        .btn-outline { background: transparent; border: 2px solid #ef4444; color: #ef4444; margin-top: 10px; }
        .std-hours-group { display: flex; gap: 8px; margin-bottom: 15px; }
        .std-btn { flex: 1; padding: 10px 0; border: 1px solid var(--line); border-radius: 12px; background: #fff; color: var(--text-sub); cursor: pointer; font-size: 0.85rem; transition: 0.2s; text-align: center;}
        .std-btn.active { border-color: var(--primary); background: var(--primary); color: white; }

        .fab { position: fixed; bottom: 90px; right: 24px; width: 58px; height: 58px; border-radius: 20px; background: var(--primary-dark); color: #fff; border: none; font-size: 1.5rem; box-shadow: 0 10px 25px rgba(94, 80, 70, 0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 12px 0 24px 0; display: flex; justify-content: space-around; border-top: 1px solid var(--line); z-index: 60; }
        .nav-btn { background: none; border: none; color: #ccc; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.7rem; font-weight: 600; cursor: pointer;}
        .nav-btn.active { color: var(--primary-dark); }
        .nav-btn i { font-size: 1.4rem; }

        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px; }
        .cal-title { font-weight: 700; font-size: 1rem; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .cal-head { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 5px; }
        .cal-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 50%; font-size: 0.9rem; cursor: pointer; transition: 0.2s; position: relative; }
        .cal-cell.is-holiday { background: #fee2e2; color: #b91c1c; font-weight: bold; }
        .cal-cell.today { border: 1px solid var(--primary); color: var(--primary); }
        .cal-nav-btn { background:none; border:none; color:var(--primary); font-size:1.2rem; cursor:pointer; }
        .toggle-group { display:flex; gap:10px; }
        .toggle-opt { flex:1; padding:12px; border:2px solid var(--line); border-radius:12px; background:#fff; color:var(--text-sub); font-size:0.9rem; font-weight:600; text-align:center; cursor:pointer; }
        .toggle-opt.active { border-color:var(--primary); color:var(--primary-dark); background:#fdfbf9; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeUp 0.3s; }
        @keyframes fadeUp { from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)} }
        #loadingMask { position:fixed; inset:0; background:var(--bg-body); z-index:2000; display:flex; justify-content:center; align-items:center; flex-direction:column; gap:15px; color:var(--primary); font-weight:bold; transition: opacity 0.5s;}
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <div class="login-title">WLB ç™»å…¥</div>
            <input type="text" id="loginUser" class="form-input" placeholder="ä½¿ç”¨è€…åç¨± (ä¾‹å¦‚: wing)" style="margin-bottom:10px">
            <input type="password" id="loginPass" class="form-input" placeholder="å¯†ç¢¼" style="margin-bottom:20px">
            <button class="btn btn-primary" onclick="window.appLogin()">é€²å…¥æ‡‰ç”¨</button>
        </div>
    </div>

    <div id="loadingMask" style="display:none">
        <i class="fa-solid fa-cloud fa-bounce" style="font-size:3rem"></i>
        <span>è¼‰å…¥å€‹äººè³‡æ–™...</span>
    </div>

    <header>
        <h1>WLB <span class="ver-tag">v5.0</span> <div class="status-dot" id="statusDot"></div></h1>
        <div class="header-actions">
            <button class="btn-icon">
                <i class="fa-solid fa-calendar-days"></i>
                <input type="month" id="dateJumper" onchange="window.app.jumpToDate(this.value)">
            </button>
            <button class="btn-icon" onclick="window.app.openSettings()"><i class="fa-solid fa-gear"></i></button>
        </div>
    </header>

    <main>
        <div id="tab-home" class="tab-content active">
            <div class="big-cal-wrapper">
                <div class="bc-header">
                    <button class="btn-icon" onclick="window.app.navMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                    <div class="bc-title" id="bcTitle"></div>
                    <button class="btn-icon" onclick="window.app.navMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div class="bc-grid"><div class="bc-head">æ—¥</div><div class="bc-head">ä¸€</div><div class="bc-head">äºŒ</div><div class="bc-head">ä¸‰</div><div class="bc-head">å››</div><div class="bc-head">äº”</div><div class="bc-head">å…­</div></div>
                <div class="bc-grid" id="bcBody"></div>
            </div>
            <div class="day-header">
                <div class="dh-title" id="dateTitleLabel"></div>
                <div id="dateStatusBadge"></div>
            </div>
            <div id="dayRecords"></div>
        </div>

        <div id="tab-stats" class="tab-content">
            <h3 style="margin-bottom:15px; color:var(--text-main)">æ•¸æ“šæ¦‚è¦½</h3>
            <div class="stats-grid">
                <div class="stat-card card-sl">
                    <div class="sc-icon-box"><i class="fa-solid fa-notes-medical"></i></div>
                    <div class="sc-title">ç—…å‡ (SL)</div>
                    <div class="sc-val-row"><span class="sc-val" id="cardSL_Rem">--</span><span class="sc-unit">å¤©</span></div>
                    <div><div class="progress-container"><div class="progress-bar" id="barSL" style="width:0%"></div></div><div class="sc-sub"><span>å·²ç”¨ <span id="cardSL_Used">0</span></span><span>ç´¯ç© <span id="cardSL_Total">0</span></span></div></div>
                </div>
                <div class="stat-card card-al">
                    <div class="sc-icon-box"><i class="fa-solid fa-umbrella-beach"></i></div>
                    <div class="sc-title">å¹´å‡ (AL)</div>
                    <div class="sc-val-row"><span class="sc-val" id="cardAL_Rem">--</span><span class="sc-unit">å¤©</span></div>
                    <div><div class="progress-container"><div class="progress-bar" id="barAL" style="width:0%"></div></div><div class="sc-sub"><span>å·²ç”¨ <span id="cardAL_Used">0</span></span><span>å¹´é¡ <span id="cardAL_Total">0</span></span></div></div>
                </div>
                <div class="stat-card card-ot">
                    <div class="sc-icon-box"><i class="fa-solid fa-briefcase"></i></div>
                    <div class="sc-title">OT æ™‚æ•¸</div>
                    <div class="sc-val-row"><span class="sc-val" id="cardOT_Hours">--</span><span class="sc-unit">h</span></div>
                    <div class="sc-sub" style="margin-top:10px">ç´¯è¨ˆåŠ ç­ç¸½æ™‚æ•¸</div>
                </div>
                <div class="stat-card card-cl">
                    <div class="sc-icon-box"><i class="fa-solid fa-calendar-check"></i></div>
                    <div class="sc-title">OT è£œå‡</div>
                    <div class="sc-val-row"><span class="sc-val" id="cardCL_Rem">--</span><span class="sc-unit">å¤©</span></div>
                    <div><div class="progress-container"><div class="progress-bar" id="barCL" style="width:0%"></div></div><div class="sc-sub"><span>å·²æŠµæ‰£ <span id="cardCL_Used">0</span></span><span>å¯æ› <span id="cardCL_Total">0</span></span></div></div>
                </div>
            </div>
            <div class="chart-section"><div class="chart-header"><i class="fa-solid fa-chart-pie"></i> OT æ™‚æ®µåˆ†ä½ˆ</div><div class="chart-wrap"><canvas id="pieChart"></canvas></div></div>
            <div class="chart-section"><div class="chart-header"><i class="fa-solid fa-chart-simple"></i> æ¯æœˆ OT è¶¨å‹¢</div><div class="chart-wrap"><canvas id="barChart"></canvas></div></div>
        </div>

        <div id="tab-logs" class="tab-content">
            <h3>æ­·å²ç´€éŒ„</h3>
            <div id="fullList"></div>
        </div>
    </main>

    <button class="fab" onclick="window.app.triggerAdd()"><i class="fa-solid fa-plus"></i></button>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="window.app.switchTab('home')" id="nav-home"><i class="fa-solid fa-calendar-days"></i> æ—¥ç¨‹</button>
        <button class="nav-btn" onclick="window.app.switchTab('stats')" id="nav-stats"><i class="fa-solid fa-chart-simple"></i> çµ±è¨ˆ</button>
        <button class="nav-btn" onclick="window.app.switchTab('logs')" id="nav-logs"><i class="fa-solid fa-list"></i> ç´€éŒ„</button>
    </nav>

    <div class="modal-overlay" id="setModal" onclick="if(event.target===this) document.getElementById('setModal').classList.remove('open')">
        <div class="modal-card">
            <h3 style="margin-top:0">è¨­å®š</h3>
            <p style="text-align:center; color:var(--primary); font-size:0.9rem; margin-bottom:15px;">ç›®å‰ç™»å…¥èº«åˆ†: <span id="displayUser" style="font-weight:bold;"></span></p>
            <label class="form-label">å·¥ä½œæ¨¡å¼</label>
            <div class="toggle-group">
                <div class="toggle-opt" id="modeMonFri" onclick="window.app.setWorkMode('mon_fri')">ä¸€è‡³äº”</div>
                <div class="toggle-opt" id="modeAltSat" onclick="window.app.setWorkMode('alt_sat')">é•·çŸ­é€±</div>
            </div>
            <div id="satSetting" style="display:none; margin-top:10px;">
                <label class="form-label">é•·çŸ­é€±åŸºæº–æ—¥</label><input type="date" class="form-input" id="setBaseSat">
            </div>
            <label class="form-label">å‡æœŸè¨­å®š</label>
            <div style="background:#faf9f7; padding:15px; border-radius:16px; border:1px solid var(--line); margin-bottom:15px;">
                <div class="cal-header">
                    <button class="cal-nav-btn" onclick="window.app.navHolidayMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                    <span class="cal-title" id="holCalTitle"></span>
                    <button class="cal-nav-btn" onclick="window.app.navHolidayMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div class="cal-grid"><div class="cal-head">æ—¥</div><div class="cal-head">ä¸€</div><div class="cal-head">äºŒ</div><div class="cal-head">ä¸‰</div><div class="cal-head">å››</div><div class="cal-head">äº”</div><div class="cal-head">å…­</div></div>
                <div class="cal-grid" id="holCalBody"></div>
                <p style="text-align:center; font-size:0.75rem; color:var(--text-sub); margin-top:10px;">ğŸ”´ ç´…è‰²ç‚ºå‡æœŸ</p>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <div><label class="form-label">å¹´å‡é¡åº¦</label><input type="number" class="form-input" id="setAL"></div>
                <div><label class="form-label">æ—¥å·¥æ™‚</label><input type="number" class="form-input" id="setDaily"></div>
            </div>
            <label class="form-label">å…¥è·æ—¥æœŸ</label><input type="date" class="form-input" id="setJoinDate">
            <button class="btn btn-primary" onclick="window.app.saveSettings(this)">å„²å­˜è¨­å®š</button>
            <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
            <button class="btn btn-outline" style="border-color:var(--primary); color:var(--primary);" onclick="window.app.downloadBackup()">â¬‡ï¸ ä¸‹è¼‰å‚™ä»½ (JSON)</button>
            <div style="margin-top:10px;">
                <input type="file" id="fileBackup" accept=".json" style="display:none" onchange="window.app.restoreBackup(this)">
                <button class="btn btn-outline" style="border-color:#666; color:#666;" onclick="document.getElementById('fileBackup').click()">â¬†ï¸ é‚„åŸå‚™ä»½</button>
            </div>
            <input type="file" id="fileRecord" accept=".csv" style="display:none" onchange="window.app.importRecords(this)">
            <button class="btn btn-outline" style="margin-top:10px;" onclick="document.getElementById('fileRecord').click()">ğŸ“„ åŒ¯å…¥ CSV (Excel)</button>
            <button class="btn btn-outline" style="margin-top:10px; border-color:#ef4444; color:#ef4444;" onclick="location.reload()">ğŸ”’ ç™»å‡º</button>
        </div>
    </div>

    <div class="modal-overlay" id="recModal" onclick="if(event.target===this) window.app.closeModal()">
        <div class="modal-card">
            <h3 id="modalDateTitle" style="margin-top:0">æ–°ç´€éŒ„</h3>
            <form id="recForm" onsubmit="window.app.saveRecord(event)">
                <input type="hidden" id="editId"><input type="hidden" id="recType" value="OT">
                <label class="form-label" style="margin-top:0">æ—¥æœŸ</label>
                <input type="date" class="form-input" id="inpDate" required onchange="window.app.onModalDateChange(this.value)">
                <div style="display:flex; background:#faf9f7; padding:5px; border-radius:18px; margin:20px 0; border:1px solid var(--line);">
                    <button type="button" id="btnTypeOT" class="btn" style="margin:0; background:white; color:var(--primary-dark); box-shadow:0 2px 8px rgba(0,0,0,0.05);" onclick="window.app.setType('OT')">åŠ ç­ OT</button>
                    <button type="button" id="btnTypeLeave" class="btn" style="margin:0; background:transparent; color:var(--text-sub); box-shadow:none;" onclick="window.app.setType('Leave')">è«‹å‡</button>
                </div>
                <div id="secOT">
                    <label class="form-label">æ‰£é™¤å·¥æ™‚</label>
                    <div class="std-hours-group">
                        <button type="button" class="std-btn active" id="btnStd9" onclick="window.app.setStdHours(9)">9h</button>
                        <button type="button" class="std-btn" id="btnStd8" onclick="window.app.setStdHours(8)">8h</button>
                        <button type="button" class="std-btn" id="btnStd4" onclick="window.app.setStdHours(4)">4h</button>
                        <button type="button" class="std-btn" id="btnStd0" onclick="window.app.setStdHours(0)">0h</button>
                    </div>
                    <input type="number" id="inpStdVal" value="9" style="display:none;"> 
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div><label class="form-label">ä¸Šç­</label><input type="time" class="form-input" id="inpIn" onchange="window.app.calcOT()"></div>
                        <div><label class="form-label">ä¸‹ç­</label><input type="time" class="form-input" id="inpOut" onchange="window.app.calcOT()"></div>
                    </div>
                    <div id="otMsg" style="text-align:right; font-size:0.8rem; color:var(--primary); margin-top:8px; height:1.2em;"></div>
                    <label class="form-label">OT æ™‚æ•¸</label><input type="number" step="0.1" class="form-input" id="inpHours" placeholder="çµæœ">
                </div>
                <div id="secLeave" style="display:none;">
                    <label class="form-label">å‡åˆ¥</label>
                    <select class="form-input" id="inpLeaveType"><option value="AL">å¹´å‡/è£œå‡ (AL)</option><option value="SL">ç—…å‡ (SL)</option></select>
                    <label class="form-label">å¤©æ•¸</label><input type="number" step="0.5" class="form-input" id="inpDays" value="1">
                    <p style="font-size:0.75rem; color:var(--text-sub); margin-top:5px">å„ªå…ˆæ‰£é™¤ OT è£œå‡ï¼Œä¸è¶³æ™‚æ‰£å¹´å‡</p>
                </div>
                <label class="form-label">å‚™è¨»</label><input type="text" class="form-input" id="inpNote">
                <div style="margin-top:20px; display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="chkIsHoliday" style="width:20px; height:20px;">
                    <label for="chkIsHoliday" style="font-size:0.9rem; color:var(--text-main)">è¨­ç‚ºå‡æœŸ (ç´…æ—¥)</label>
                </div>
                <button type="submit" class="btn btn-primary">å„²å­˜</button>
                <button type="button" class="btn btn-outline" style="display:none;" id="btnDel" onclick="window.app.delRecord(this)">åˆªé™¤</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ======================================================
        // ğŸ”§ USER CONFIG: Add users here
        // ======================================================
        const ALLOWED_USERS = {
            "WINGYAN": "852258", // Username: Password
            "FTH": "77461"
        };
        // ======================================================

        const firebaseConfig = {
            apiKey: "AIzaSyAi_iDY4JeppmveW5-Uq2cMRWJY9jeT9Dw",
            authDomain: "work-life-balance-9f09b.firebaseapp.com",
            projectId: "work-life-balance-9f09b",
            storageBucket: "work-life-balance-9f09b.firebasestorage.app",
            messagingSenderId: "869347289477",
            appId: "1:869347289477:web:c2bee07bc2aeb92973bcec",
            measurementId: "G-94EXTK7W8Y"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let docRef; // Dynamic Reference
        let currentUser = null;

        const PRESET_HOLIDAYS = [
            {date:"2025-01-01",name:"å…ƒæ—¦"},{date:"2025-01-29",name:"è¾²æ›†å¹´åˆä¸€"},{date:"2025-01-30",name:"è¾²æ›†å¹´åˆäºŒ"},{date:"2025-01-31",name:"è¾²æ›†å¹´åˆä¸‰"},{date:"2025-04-04",name:"æ¸…æ˜ç¯€"},{date:"2025-04-18",name:"è€¶ç©Œå—é›£ç¯€"},{date:"2025-04-19",name:"è€¶ç©Œå—é›£ç¯€ç¿Œæ—¥"},{date:"2025-04-21",name:"å¾©æ´»ç¯€æ˜ŸæœŸä¸€"},{date:"2025-05-01",name:"å‹å‹•ç¯€"},{date:"2025-05-05",name:"ä½›èª•"},{date:"2025-05-31",name:"ç«¯åˆç¯€"},{date:"2025-07-01",name:"é¦™æ¸¯ç‰¹åˆ¥è¡Œæ”¿å€æˆç«‹ç´€å¿µæ—¥"},{date:"2025-10-01",name:"åœ‹æ…¶æ—¥"},{date:"2025-10-07",name:"ä¸­ç§‹ç¯€ç¿Œæ—¥"},{date:"2025-10-29",name:"é‡é™½ç¯€"},{date:"2025-12-25",name:"è–èª•ç¯€"},{date:"2025-12-26",name:"è–èª•ç¯€å¾Œç¬¬ä¸€å€‹å‘¨æ—¥"},
            {date:"2026-01-01",name:"å…ƒæ—¦"},{date:"2026-02-17",name:"è¾²æ›†å¹´åˆä¸€"},{date:"2026-02-18",name:"è¾²æ›†å¹´åˆäºŒ"},{date:"2026-02-19",name:"è¾²æ›†å¹´åˆä¸‰"},{date:"2026-04-03",name:"è€¶ç©Œå—é›£ç¯€"},{date:"2026-04-04",name:"è€¶ç©Œå—é›£ç¯€ç¿Œæ—¥"},{date:"2026-04-06",name:"æ¸…æ˜ç¯€ç¿Œæ—¥"},{date:"2026-04-07",name:"å¾©æ´»ç¯€æ˜ŸæœŸä¸€ç¿Œæ—¥"},{date:"2026-05-01",name:"å‹å‹•ç¯€"},{date:"2026-05-25",name:"ä½›èª•ç¿Œæ—¥"},{date:"2026-06-19",name:"ç«¯åˆç¯€"},{date:"2026-07-01",name:"é¦™æ¸¯ç‰¹åˆ¥è¡Œæ”¿å€æˆç«‹ç´€å¿µæ—¥"},{date:"2026-09-26",name:"ä¸­ç§‹ç¯€ç¿Œæ—¥"},{date:"2026-10-01",name:"åœ‹æ…¶æ—¥"},{date:"2026-10-19",name:"é‡é™½ç¯€ç¿Œæ—¥"},{date:"2026-12-25",name:"è–èª•ç¯€"},{date:"2026-12-26",name:"è–èª•ç¯€å¾Œç¬¬ä¸€å€‹å‘¨æ—¥"}
        ];

        let localData = { records: [], settings: { workMode: "alt_sat", baseSat: "2025-09-13", joinDate: "2024-09-01", holidays: PRESET_HOLIDAYS, alBalance: 14, dailyHours: 8 } };
        let selectedDate = new Date();
        let calViewDate = new Date(); 
        let holidayCalDate = new Date(); 
        let curType = 'OT';
        let editId = null;
        let pieChart = null, barChart = null;
        let isDataLoaded = false;

        function formatDate(d) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        // --- LOGIN LOGIC ---
        window.appLogin = function() {
            const u = document.getElementById('loginUser').value.trim();
            const p = document.getElementById('loginPass').value.trim();
            
            if(ALLOWED_USERS[u] && ALLOWED_USERS[u] === p) {
                currentUser = u;
                document.getElementById('displayUser').innerText = u;
                
                // Connect to specific user document: personal_data_USERID
                // For 'wing', we use 'personal_data_v2' to keep your recovered data!
                // For others, we use 'data_USERNAME'
                const docId = (u === 'wing') ? 'personal_data_v2' : ('data_' + u);
                
                docRef = doc(db, "worklife_app", docId);
                initFirebase();
                
                // UI Transition
                document.getElementById('loginScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.querySelector('main').style.opacity = '1';
                }, 500);
            } else {
                alert("ç”¨æˆ¶åæˆ–å¯†ç¢¼éŒ¯èª¤");
            }
        }

        function initFirebase() {
            const loading = document.getElementById('loadingMask');
            loading.style.display = 'flex';
            
            onSnapshot(docRef, (docSnap) => {
                const dot = document.getElementById('statusDot');
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(!data.settings.workMode) data.settings.workMode = 'alt_sat';
                    if(data.settings.holidays.length && typeof data.settings.holidays[0] === 'string') data.settings.holidays = PRESET_HOLIDAYS;
                    if(data.records) data.records.forEach(r => r.date = r.date.replace(/\//g, '-'));
                    localData = data;
                    dot.className = 'status-dot online';
                    isDataLoaded = true;
                    refreshApp();
                } else { 
                    setDoc(docRef, localData);
                    dot.className = 'status-dot online';
                    isDataLoaded = true; 
                }
                loading.style.opacity = '0'; setTimeout(()=>loading.style.display='none', 500);
            }, (err) => { document.getElementById('statusDot').className = 'status-dot offline'; loading.style.display='none'; });
        }

        window.app = {
            openSettings: () => {
                document.getElementById('setModal').classList.add('open');
                const s = localData.settings;
                window.app.setWorkMode(s.workMode || 'alt_sat');
                document.getElementById('setBaseSat').value = s.baseSat || '';
                document.getElementById('setJoinDate').value = s.joinDate || '';
                document.getElementById('setAL').value = s.alBalance;
                document.getElementById('setDaily').value = s.dailyHours;
                holidayCalDate = new Date();
                renderHolidayCalendar();
            },
            setWorkMode: (mode) => {
                localData.settings.workMode = mode;
                document.getElementById('modeMonFri').className = `toggle-opt ${mode==='mon_fri'?'active':''}`;
                document.getElementById('modeAltSat').className = `toggle-opt ${mode==='alt_sat'?'active':''}`;
                document.getElementById('satSetting').style.display = mode==='alt_sat' ? 'block' : 'none';
            },
            saveSettings: async (btn) => {
                if(!isDataLoaded) return;
                const originalText = btn.innerText;
                btn.innerText = "â³..."; btn.disabled = true;
                try {
                    const s = localData.settings;
                    s.baseSat = document.getElementById('setBaseSat').value;
                    s.joinDate = document.getElementById('setJoinDate').value;
                    s.alBalance = Number(document.getElementById('setAL').value);
                    s.dailyHours = Number(document.getElementById('setDaily').value);
                    await pushToCloud();
                    document.getElementById('setModal').classList.remove('open');
                    alert("âœ… å·²å„²å­˜");
                } catch(e) { alert("âŒ éŒ¯èª¤"); }
                finally { btn.innerText = originalText; btn.disabled = false; }
            },
            downloadBackup: () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(localData));
                const dlAnchorElem = document.createElement('a');
                dlAnchorElem.setAttribute("href", dataStr);
                dlAnchorElem.setAttribute("download", `wlb_backup_${currentUser}_${formatDate(new Date())}.json`);
                dlAnchorElem.click();
            },
            restoreBackup: (input) => {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const backup = JSON.parse(e.target.result);
                        if(confirm(`ç¢ºå®šè¦é‚„åŸå‚™ä»½ï¼Ÿ\n(ç´€éŒ„: ${backup.records.length} ç­†)`)) {
                            localData = backup;
                            await pushToCloud();
                            alert("âœ… é‚„åŸæˆåŠŸï¼");
                            location.reload();
                        }
                    } catch(err) { alert("âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
                };
                reader.readAsText(file);
                input.value = '';
            },
            importRecords: (input) => {
                const file = input.files[0]; if(!file) return;
                const r = new FileReader();
                r.onload = async (e) => {
                    const lines = e.target.result.split(/\r\n|\n|\r/);
                    let count = 0;
                    lines.forEach((l) => {
                        let cleanLine = l.trim();
                        if (cleanLine.charCodeAt(0) === 0xFEFF) cleanLine = cleanLine.slice(1);
                        if(!cleanLine || cleanLine.toLowerCase().includes('date')) return;
                        const parts = cleanLine.split(/,|;/);
                        if(parts.length >= 3) {
                            let d = parts[0].trim().replace(/\//g, '-');
                            const t = parts[1].trim(); 
                            const v = parts[2].trim();
                            if(/^\d{4}-\d{2}-\d{2}$/.test(d)) {
                                localData.records.push({
                                    id: Date.now()+Math.random(), date: d, type: t,
                                    subType: t==='Leave'?'AL':null, val: v, note: parts[3]?parts[3].trim():''
                                }); count++;
                            }
                        }
                    });
                    await pushToCloud(); alert(`æˆåŠŸåŒ¯å…¥ ${count} ç­†ç´€éŒ„`); input.value='';
                }; r.readAsText(file);
            },
            navHolidayMonth: (d) => {
                holidayCalDate.setMonth(holidayCalDate.getMonth() + d);
                renderHolidayCalendar();
            },
            toggleHoliday: (dStr) => {
                const exists = localData.settings.holidays.find(h => h.date === dStr);
                if(exists) {
                    if(confirm(`ç§»é™¤ ${dStr} (${exists.name}) å‡æœŸï¼Ÿ`)) {
                        localData.settings.holidays = localData.settings.holidays.filter(h => h.date !== dStr);
                    }
                } else {
                    const name = prompt(`å°‡ ${dStr} è¨­ç‚ºå‡æœŸï¼Œè«‹è¼¸å…¥åç¨±ï¼š`, "ä¼‘å‡");
                    if(name) localData.settings.holidays.push({date: dStr, name: name});
                }
                renderHolidayCalendar();
            },
            triggerAdd: () => openModal(),
            closeModal: () => document.getElementById('recModal').classList.remove('open'),
            switchTab: (t) => {
                document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
                document.getElementById(`tab-${t}`).classList.add('active');
                document.getElementById(`nav-${t}`).classList.add('active');
                if(t==='stats') { updateStats(); renderCharts(); }
            },
            setType: (t) => setType(t), 
            setStdHours: (h) => {
                document.getElementById('inpStdVal').value = h;
                document.querySelectorAll('.std-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('btnStd'+h).classList.add('active');
                window.app.calcOT();
            },
            calcOT: () => calcOT(), 
            saveRecord: (e) => saveRecord(e), delRecord: (b) => delRecord(b), 
            navMonth: (dir) => {
                calViewDate.setMonth(calViewDate.getMonth() + dir);
                renderBigCalendar();
            },
            selectDate: (d) => selectDate(d),
            onModalDateChange: (val) => {
                if(!val) return;
                const d = new Date(val); 
                const status = getDayStatus(d);
                let defaultStd = 9; 
                if(status.isOff) defaultStd = 0; 
                else if(status.type === 'WORK_SAT') defaultStd = 4;
                window.app.setStdHours(defaultStd);
            },
            jumpToDate: (val) => {
                if(!val) return;
                const [y, m] = val.split('-');
                calViewDate = new Date(y, m - 1, 1);
                renderBigCalendar();
                window.app.selectDate(new Date(y, m - 1, 1));
            }
        };

        async function pushToCloud() { await setDoc(docRef, localData); }

        function getDayStatus(d) {
            const dStr = formatDate(d);
            const s = localData.settings;
            const hol = s.holidays.find(h=>h.date===dStr);
            if(hol) return { type: 'HOLIDAY', name: hol.name, isOff: true };
            if(d.getDay()===0) return { type: 'OFF', name: 'é€±æ—¥', isOff: true };
            if(d.getDay()===6) {
                if(s.workMode==='mon_fri') return { type: 'OFF', name: 'é€±å…­(ä¼‘)', isOff: true };
                if(!s.baseSat) return { type: 'OFF', name: 'é€±å…­', isOff: true }; 
                const base = new Date(s.baseSat); const target = new Date(dStr);
                if(target < base) return { type: 'OFF', name: 'é€±å…­', isOff: true };
                let cnt = 0, curr = new Date(base);
                if (curr > target) return { type: 'OFF', name: 'é€±å…­', isOff: true };
                while(curr <= target) {
                    const cStr = formatDate(curr);
                    if(!s.holidays.some(h=>h.date===cStr)) { if(cStr===dStr) break; cnt++; }
                    curr.setDate(curr.getDate()+7);
                }
                return (cnt%2===0) ? { type: 'WORK_SAT', name: 'é•·é€±ä¸Šç­', isOff: false } : { type: 'OFF_SAT', name: 'çŸ­é€±ä¼‘å‡', isOff: true };
            }
            return { type: 'WORK', name: 'å·¥ä½œæ—¥', isOff: false };
        }

        function refreshApp() {
            renderBigCalendar();
            const dStr = formatDate(selectedDate);
            const status = getDayStatus(selectedDate);
            const badgeClass = status.isOff ? (status.type==='HOLIDAY'?'badge-hol':'badge-off') : 'badge-work';
            const statusText = status.isOff ? (status.type==='HOLIDAY'?status.name:'ä¼‘å‡') : 'ä¸Šç­';
            document.getElementById('dateTitleLabel').innerHTML = dStr;
            document.getElementById('dateStatusBadge').innerHTML = `<span class="dh-badge ${badgeClass}">${statusText}</span>`;
            const recs = localData.records.filter(r => r.date === dStr);
            document.getElementById('dayRecords').innerHTML = recs.length ? recs.map(renderItem).join('') : `<div style="text-align:center;padding:30px;color:#ccc;background:#faf9f7;border-radius:16px;border:1px solid #eee"><div style="font-size:0.9rem">ç„¡ç´€éŒ„</div></div>`;
            updateStats(); renderAllLogs();
        }

        function renderBigCalendar() {
            const grid = document.getElementById('bcBody'); grid.innerHTML = '';
            const y = calViewDate.getFullYear(), m = calViewDate.getMonth();
            document.getElementById('bcTitle').innerText = `${y}å¹´ ${m+1}æœˆ`;
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m+1, 0).getDate();
            const todayStr = formatDate(new Date()); 
            const selStr = formatDate(selectedDate);
            for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';
            for(let i=1; i<=daysInMonth; i++) {
                const date = new Date(y, m, i);
                const dStr = formatDate(date); 
                const status = getDayStatus(date);
                const recs = localData.records.filter(r => r.date === dStr);
                const el = document.createElement('div');
                el.className = `bc-day ${dStr===todayStr?'today':''} ${dStr===selStr?'selected':''}`;
                if(status.type === 'HOLIDAY') el.style.color = '#ef4444';
                let dotHtml = '';
                if(status.type === 'HOLIDAY') dotHtml += '<div class="dot holiday"></div>';
                if(recs.length > 0) dotHtml += '<div class="dot record"></div>';
                el.innerHTML = `<span>${i}</span><div class="bc-dots">${dotHtml}</div>`;
                el.onclick = () => window.app.selectDate(date);
                grid.appendChild(el);
            }
        }

        function renderHolidayCalendar() {
            const grid = document.getElementById('holCalBody');
            grid.innerHTML = '';
            const year = holidayCalDate.getFullYear();
            const month = holidayCalDate.getMonth();
            document.getElementById('holCalTitle').innerText = `${year}å¹´ ${month+1}æœˆ`;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';
            for(let i=1; i<=daysInMonth; i++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const isHol = localData.settings.holidays.some(h => h.date === dateStr);
                const el = document.createElement('div');
                el.className = `cal-cell ${isHol?'is-holiday':''}`;
                el.innerText = i;
                el.onclick = () => window.app.toggleHoliday(dateStr);
                grid.appendChild(el);
            }
        }

        function renderCharts() {
            if(pieChart) pieChart.destroy();
            if(barChart) barChart.destroy();
            const otRecords = localData.records.filter(r => r.type === 'OT');
            let dist = { work: 0, sat: 0, holiday: 0 };
            otRecords.forEach(r => {
                const d = new Date(r.date);
                const status = getDayStatus(d);
                const val = parseFloat(r.val);
                if(status.type === 'HOLIDAY' || d.getDay()===0) dist.holiday += val;
                else if(d.getDay()===6) dist.sat += val;
                else dist.work += val;
            });
            const ctxPie = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: ['å·¥ä½œæ—¥', 'é€±å…­', 'ç´…æ—¥/é€±æ—¥'],
                    datasets: [{ data: [dist.work, dist.sat, dist.holiday], backgroundColor: ['#f87171', '#60a5fa', '#fbbf24'] }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
            let monthly = {};
            otRecords.forEach(r => {
                const key = r.date.substring(0, 7); 
                if(!monthly[key]) monthly[key] = 0;
                monthly[key] += parseFloat(r.val);
            });
            const labels = Object.keys(monthly).sort();
            const data = labels.map(k => monthly[k]);
            const ctxBar = document.getElementById('barChart').getContext('2d');
            barChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'OT æ™‚æ•¸', data: data, backgroundColor: '#d6c6b9', borderRadius: 6 }]
                },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        function selectDate(d) {
            selectedDate = d;
            if(d.getMonth() !== calViewDate.getMonth()) calViewDate = new Date(d);
            refreshApp();
        }

        function renderAllLogs() {
            const sorted = [...localData.records].sort((a,b) => new Date(b.date) - new Date(a.date));
            document.getElementById('fullList').innerHTML = sorted.map(renderItem).join('');
        }
        function renderItem(r) {
            const isOT = r.type === 'OT';
            return `<div class="log-item" onclick="window.appSelectRecord(${r.id})"><div class="log-icon ${isOT?'icon-ot':'icon-leave'}"><i class="fa-solid ${isOT?'fa-clock':'fa-mug-hot'}"></i></div><div class="log-main"><div class="log-title">${isOT?'OT åŠ ç­' : (r.subType==='AL'?'å¹´å‡ (AL)':'ç—…å‡ (SL)')}</div><div class="log-date">${r.date} ${r.note?'Â· '+r.note:''}</div></div><div class="log-val">${isOT ? '+'+r.val+'h' : '-'+r.val+'å¤©'}</div></div>`;
        }
        window.appSelectRecord = (id) => { const r = localData.records.find(item => item.id === id); if(r) openModal(r); };

        function updateStats() {
            const s = localData.settings;
            const now = new Date();
            const joinD = s.joinDate ? new Date(s.joinDate) : new Date(); 
            let months = (now.getFullYear() - joinD.getFullYear()) * 12 + (now.getMonth() - joinD.getMonth());
            if(now.getDate() < joinD.getDate()) months--;
            const totalSL = Math.max(0, months * 2);
            const usedSL = localData.records.filter(r=>r.type==='Leave'&&r.subType==='SL').reduce((a,b)=>a+Number(b.val),0);
            document.getElementById('cardSL_Total').innerText = totalSL;
            document.getElementById('cardSL_Used').innerText = usedSL;
            document.getElementById('cardSL_Rem').innerText = totalSL - usedSL;
            document.getElementById('barSL').style.width = (totalSL>0?(usedSL/totalSL)*100:0)+'%';

            const totalOTHours = localData.records.filter(r=>r.type==='OT').reduce((a,b)=>a+Number(b.val),0);
            document.getElementById('cardOT_Hours').innerText = totalOTHours.toFixed(1);
            
            const dailyHours = s.dailyHours || 8;
            const earnedCompDays = totalOTHours / dailyHours; 
            
            let currentYear = now.getFullYear();
            if(now.getMonth() < 8) currentYear--; 
            const startAL = new Date(currentYear, 8, 1); 
            const vacationRecords = localData.records.filter(r => 
                r.type==='Leave' && r.subType==='AL' && new Date(r.date) >= startAL
            );
            const totalVacationTaken = vacationRecords.reduce((a,b)=>a+Number(b.val),0);
            let usedComp = 0;
            let usedAL = 0;
            if(totalVacationTaken <= earnedCompDays) {
                usedComp = totalVacationTaken;
                usedAL = 0;
            } else {
                usedComp = earnedCompDays;
                usedAL = totalVacationTaken - earnedCompDays;
            }
            document.getElementById('cardCL_Total').innerText = earnedCompDays.toFixed(1);
            document.getElementById('cardCL_Used').innerText = usedComp.toFixed(1);
            document.getElementById('cardCL_Rem').innerText = (earnedCompDays - usedComp).toFixed(1);
            document.getElementById('barCL').style.width = (earnedCompDays>0?(usedComp/earnedCompDays)*100:0)+'%';

            const totalAL = s.alBalance;
            document.getElementById('cardAL_Total').innerText = totalAL;
            document.getElementById('cardAL_Used').innerText = usedAL.toFixed(1);
            document.getElementById('cardAL_Rem').innerText = (totalAL - usedAL).toFixed(1);
            document.getElementById('barAL').style.width = (totalAL>0?(usedAL/totalAL)*100:0)+'%';
        }
        
        function openModal(r = null) {
            document.getElementById('recModal').classList.add('open');
            const dStr = formatDate(selectedDate);
            document.getElementById('inpDate').value = dStr;
            window.app.onModalDateChange(dStr); 
            if(r) { 
                editId=r.id; 
                document.getElementById('inpDate').value = r.date;
                document.getElementById('inpNote').value=r.note||''; 
                const isHoliday = localData.settings.holidays.some(h=>h.date===r.date);
                document.getElementById('chkIsHoliday').checked = isHoliday;
                setType(r.type); 
                if(r.type==='OT') document.getElementById('inpHours').value=r.val; 
                else{ document.getElementById('inpLeaveType').value=r.subType; document.getElementById('inpDays').value=r.val; } 
                document.getElementById('btnDel').style.display='block'; 
                window.app.onModalDateChange(r.date);
            } else { 
                editId=null; 
                document.getElementById('recForm').reset(); 
                document.getElementById('inpDate').value = dStr;
                const isHoliday = localData.settings.holidays.some(h=>h.date===dStr);
                document.getElementById('chkIsHoliday').checked = isHoliday;
                setType('OT'); 
                document.getElementById('btnDel').style.display='none';
                window.app.onModalDateChange(dStr);
            }
        }
        
        function setType(t) { curType = t; document.getElementById('recType').value = t; document.getElementById('secOT').style.display = t==='OT'?'block':'none'; document.getElementById('secLeave').style.display = t==='Leave'?'block':'none'; }
        
        function calcOT() {
            const i=document.getElementById('inpIn').value;
            const o=document.getElementById('inpOut').value;
            if(!i||!o) return;
            const mi = i.split(':').reduce((h,m)=>h*60+Number(m),0);
            const mo = o.split(':').reduce((h,m)=>h*60+Number(m),0);
            const stdHours = Number(document.getElementById('inpStdVal').value);
            let durationMins = mo - mi;
            if(durationMins < 0) durationMins += 24*60; 
            const otMins = Math.max(0, durationMins - (stdHours * 60));
            document.getElementById('inpHours').value = (otMins / 60).toFixed(1);
            document.getElementById('otMsg').innerText = `ç¸½å·¥æ™‚ ${(durationMins/60).toFixed(1)}h - æ‰£é™¤ ${stdHours}h`;
        }
        
        async function saveRecord(e) {
            e.preventDefault();
            if(!isDataLoaded) return alert("è³‡æ–™å°šæœªåŒæ­¥ï¼Œè«‹ç¨å¾Œ");
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.innerText = "â³..."; btn.disabled = true;
            try {
                const dateVal = document.getElementById('inpDate').value;
                if(!dateVal) throw new Error("è«‹é¸æ“‡æ—¥æœŸ");
                const isHolidayCheck = document.getElementById('chkIsHoliday').checked;
                const holIndex = localData.settings.holidays.findIndex(h=>h.date===dateVal);
                if(isHolidayCheck) {
                    if(holIndex === -1) localData.settings.holidays.push({date: dateVal, name: "è‡ªè¨‚å‡æœŸ"});
                } else {
                    if(holIndex !== -1) localData.settings.holidays.splice(holIndex, 1);
                }
                const val = curType==='OT' ? document.getElementById('inpHours').value : document.getElementById('inpDays').value;
                if(!val) throw new Error("è«‹è¼¸å…¥æ•¸å€¼");
                const rec = { id: editId||Date.now(), date: dateVal, type: curType, subType: curType==='Leave'?document.getElementById('inpLeaveType').value:null, val: val, note: document.getElementById('inpNote').value };
                if(editId) localData.records = localData.records.filter(r=>r.id!==editId);
                localData.records.push(rec); 
                await pushToCloud(); 
                alert("âœ… æˆåŠŸï¼"); 
                window.app.closeModal();
                if(new Date(dateVal).getMonth() !== calViewDate.getMonth()) calViewDate = new Date(dateVal);
                window.app.selectDate(new Date(dateVal));
            } catch(err) { alert("âŒ " + err.message); }
            finally { btn.innerText = originalText; btn.disabled = false; }
        }
        
        async function delRecord(btn) { 
            if(editId && confirm("åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) { 
                try { localData.records = localData.records.filter(r=>r.id!==editId); await pushToCloud(); window.app.closeModal(); } 
                catch(e){ alert("åˆªé™¤å¤±æ•—"); }
            } 
        }
    </script>
</body>
</html>
