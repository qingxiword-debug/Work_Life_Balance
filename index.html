<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Work-Life Balance v2.6</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-body: #fdfcf8; --surface: #ffffff;
            --primary: #8c7b70; --primary-dark: #5e5046;
            --text-main: #4a403a; --text-sub: #998f8a; --line: #eeeae5;
            --tag-ot: #f2ebe6; --tag-ot-text: #6e5d53;
            --tag-off: #e6f0e6; --tag-off-text: #5d7a5f;
            --radius: 18px; --shadow: 0 4px 20px rgba(140, 123, 112, 0.06);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: "Hiragino Sans", "PingFang TC", sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { padding: 15px 20px; padding-top: max(15px, env(safe-area-inset-top)); display: flex; justify-content: space-between; align-items: center; background: var(--bg-body); }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 800; color: var(--primary-dark); letter-spacing: 0.5px; display:flex; align-items:center; gap:8px;}
        .ver-tag { font-size:0.7rem; background:#eee; padding:2px 6px; border-radius:6px; color:#888; font-weight:normal;}
        .status-dot { width:8px; height:8px; border-radius:50%; background:#ccc; transition:0.3s; }
        .status-dot.online { background:#22c55e; box-shadow:0 0 5px #22c55e; }
        .status-dot.offline { background:#ef4444; }

        .header-actions { display: flex; gap: 15px; align-items: center; }
        .btn-icon { background: none; border: none; font-size: 1.2rem; color: var(--primary); cursor: pointer; padding: 5px; position: relative; }
        #dateJumper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* Scroller */
        .date-scroller-wrap { padding: 5px 0 15px 0; background: var(--bg-body); }
        .date-scroller { display: flex; overflow-x: auto; gap: 8px; padding: 0 24px; scrollbar-width: none; }
        .date-scroller::-webkit-scrollbar { display: none; }
        .date-chip { min-width: 52px; height: 68px; background: var(--surface); border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-sub); flex-shrink: 0; cursor: pointer; transition: 0.2s; border: 1px solid var(--line); position: relative; }
        .date-chip span:first-child { font-size: 0.7rem; margin-bottom: 2px; }
        .date-chip span:last-child { font-size: 1.1rem; font-weight: 700; }
        .date-chip.active { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(140, 123, 112, 0.3); }
        .date-chip.is-holiday { border-color: #fca5a5; background: #fff1f2; color: #e11d48; }
        .date-chip.active.is-holiday { background: var(--primary); border-color: transparent; color: white; }
        .has-data-dot { width:5px; height:5px; background:var(--primary); border-radius:50%; position:absolute; bottom:5px; display:none;}
        .date-chip.has-data .has-data-dot { display:block; }
        .date-chip.active .has-data-dot { background:white; }

        main { flex: 1; overflow-y: auto; padding: 0 24px 100px 24px; }
        .card { background: var(--surface); border-radius: var(--radius); padding: 22px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid var(--line); }
        .summary-card { background: linear-gradient(135deg, #b0a096 0%, #8c7b70 100%); color: white; border: none; }
        .stat-row { display: flex; justify-content: space-between; align-items: flex-end; }
        .stat-big { font-size: 2.4rem; font-weight: 700; line-height: 1; margin: 5px 0; }
        .stat-lbl { font-size: 0.8rem; opacity: 0.9; font-weight: 500;}

        /* Lists */
        .log-item { display: flex; align-items: center; padding: 14px; background: var(--surface); border-radius: 16px; margin-bottom: 10px; border: 1px solid var(--line); }
        .log-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 1rem; }
        .icon-ot { background: var(--tag-ot); color: var(--tag-ot-text); }
        .icon-leave { background: var(--tag-off); color: var(--tag-off-text); }
        .log-main { flex: 1; }
        .log-title { font-weight: 700; font-size: 0.95rem; color: var(--text-main); }
        .log-date { font-size: 0.75rem; color: var(--text-sub); margin-top: 2px; }
        .log-val { font-weight: 700; color: var(--primary-dark); font-size: 1rem;}

        /* Settings UI */
        .import-box { border: 2px dashed #d4c5b9; border-radius: 12px; padding: 15px; text-align: center; margin-bottom: 15px; background: #faf9f7; cursor: pointer; transition: 0.2s; }
        .import-box p { margin: 0; font-size: 0.85rem; color: var(--text-main); font-weight: 600; }
        .import-box span { font-size: 0.75rem; color: var(--text-sub); }
        .holiday-list { max-height: 150px; overflow-y: auto; background: #faf9f7; border-radius: 12px; padding: 10px; margin-bottom: 15px; border: 1px solid var(--line); }
        .holiday-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .holiday-date { color: var(--text-sub); font-size: 0.8rem; margin-right: 10px; }
        .toggle-group { display:flex; gap:10px; margin-bottom:10px; }
        .toggle-opt { flex:1; padding:12px; border:2px solid var(--line); border-radius:12px; background:#fff; color:var(--text-sub); font-size:0.9rem; font-weight:600; text-align:center; cursor:pointer; }
        .toggle-opt.active { border-color:var(--primary); color:var(--primary-dark); background:#fdfbf9; }

        .form-label { font-size: 0.85rem; font-weight: 700; color: var(--text-sub); margin: 15px 0 8px 0; display: block; }
        .form-input { width: 100%; padding: 14px; border: 2px solid var(--line); background: #faf9f7; border-radius: 14px; font-size: 1rem; color: var(--text-main); -webkit-appearance: none; }
        .btn { width: 100%; padding: 15px; border-radius: 14px; border: none; font-weight: 700; font-size: 1rem; margin-top: 20px; cursor: pointer; transition: 0.2s; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: var(--primary-dark); color: white; box-shadow: 0 4px 12px rgba(94, 80, 70, 0.2); }
        .btn-outline { background: transparent; border: 2px solid #ef4444; color: #ef4444; margin-top: 10px; }
        
        /* Std Hour Selector - Updated for 4 buttons */
        .std-hours-group { display: flex; gap: 8px; margin-bottom: 15px; }
        .std-btn { flex: 1; padding: 10px 0; border: 1px solid var(--line); border-radius: 12px; background: #fff; color: var(--text-sub); cursor: pointer; font-size: 0.85rem; transition: 0.2s; text-align: center;}
        .std-btn.active { border-color: var(--primary); background: var(--primary); color: white; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(74, 64, 58, 0.5); backdrop-filter: blur(4px); z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s; display: flex; align-items: flex-end; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-card { background: var(--surface); width: 100%; border-radius: 30px 30px 0 0; padding: 30px 24px 50px 24px; transform: translateY(100%); transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1); max-height: 90vh; overflow-y: auto; }
        .modal-overlay.open .modal-card { transform: translateY(0); }
        .fab { position: fixed; bottom: 90px; right: 24px; width: 58px; height: 58px; border-radius: 20px; background: var(--primary-dark); color: #fff; border: none; font-size: 1.5rem; box-shadow: 0 10px 25px rgba(94, 80, 70, 0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 12px 0 24px 0; display: flex; justify-content: space-around; border-top: 1px solid var(--line); z-index: 60; }
        .nav-btn { background: none; border: none; color: #ccc; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.7rem; font-weight: 600; cursor: pointer;}
        .nav-btn.active { color: var(--primary-dark); }
        .nav-btn i { font-size: 1.4rem; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeUp 0.3s; }
        @keyframes fadeUp { from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)} }
        #loadingMask { position:fixed; inset:0; background:var(--bg-body); z-index:2000; display:flex; justify-content:center; align-items:center; flex-direction:column; gap:15px; color:var(--primary); font-weight:bold; transition: opacity 0.5s;}
    </style>
</head>
<body>

    <div id="loadingMask">
        <i class="fa-solid fa-cloud fa-bounce" style="font-size:3rem"></i>
        <span>連線中...</span>
    </div>

    <header>
        <h1>WLB <span class="ver-tag">v2.6</span> <div class="status-dot" id="statusDot"></div></h1>
        <div class="header-actions">
            <button class="btn-icon">
                <i class="fa-solid fa-calendar-days"></i>
                <input type="month" id="dateJumper" onchange="window.app.jumpToDate(this.value)">
            </button>
            <button class="btn-icon" onclick="window.app.openSettings()"><i class="fa-solid fa-sliders"></i></button>
        </div>
    </header>

    <div class="date-scroller-wrap">
        <div class="date-scroller" id="dateScroller"></div>
    </div>

    <main>
        <div id="tab-home" class="tab-content active">
            <div class="card summary-card">
                <div class="stat-row">
                    <div>
                        <div class="stat-lbl">OT 累積</div>
                        <div class="stat-big" id="dispOT">--</div>
                        <div class="stat-lbl" style="opacity:0.9">≈ <span id="dispOTDays">--</span> 天補休</div>
                    </div>
                    <div style="text-align:right">
                        <div class="stat-lbl">病假餘額</div>
                        <div class="stat-big" style="font-size:2rem" id="dispSL">--</div>
                        <div class="stat-lbl">年假: <span id="dispAL">--</span></div>
                    </div>
                </div>
            </div>
            <h3 style="margin:0 0 12px 0; font-size:1rem; color:var(--text-sub); display:flex; justify-content:space-between; align-items:center;">
                <span>當日概覽</span>
                <span id="dateTitleLabel" style="font-weight:400; font-size:0.85rem;"></span>
            </h3>
            <div id="dayRecords"></div>
        </div>

        <div id="tab-logs" class="tab-content">
            <h3>歷史紀錄</h3>
            <div id="fullList"></div>
        </div>
    </main>

    <button class="fab" onclick="window.app.triggerAdd()"><i class="fa-solid fa-plus"></i></button>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="window.app.switchTab('home')" id="nav-home"><i class="fa-solid fa-calendar-week"></i> 日程</button>
        <button class="nav-btn" onclick="window.app.switchTab('logs')" id="nav-logs"><i class="fa-solid fa-clock-rotate-left"></i> 紀錄</button>
    </nav>

    <div class="modal-overlay" id="setModal" onclick="if(event.target===this) document.getElementById('setModal').classList.remove('open')">
        <div class="modal-card">
            <h3 style="margin-top:0">設定與資料</h3>
            
            <label class="form-label">工作模式</label>
            <div class="toggle-group">
                <div class="toggle-opt" id="modeMonFri" onclick="window.app.setWorkMode('mon_fri')">一至五<br><span style="font-size:0.7rem; font-weight:normal">週六休假</span></div>
                <div class="toggle-opt" id="modeAltSat" onclick="window.app.setWorkMode('alt_sat')">長短週<br><span style="font-size:0.7rem; font-weight:normal">隔週輪值</span></div>
            </div>
            <div id="satSetting" style="display:none; margin-top:10px;">
                <label class="form-label">長短週基準日 (上班的週六)</label>
                <input type="date" class="form-input" id="setBaseSat">
            </div>

            <label class="form-label" style="display:flex; justify-content:space-between;">
                假期管理 <span style="color:var(--primary); cursor:pointer; font-size:0.8rem;" onclick="window.app.clearHolidays()">清空</span>
            </label>
            <div class="holiday-list" id="holidayListDisplay"></div>
            
            <input type="file" id="fileHoliday" accept=".csv" style="display:none" onchange="window.app.importHolidays(this)">
            <div class="import-box" onclick="document.getElementById('fileHoliday').click()">
                <i class="fa-solid fa-file-csv"></i><p>匯入假期 Excel (.csv)</p><span>格式: YYYY-MM-DD, 節日名稱</span>
            </div>

            <input type="file" id="fileRecord" accept=".csv" style="display:none" onchange="window.app.importRecords(this)">
            <div class="import-box" onclick="document.getElementById('fileRecord').click()">
                <i class="fa-solid fa-table"></i><p>匯入歷史紀錄 Excel (.csv)</p><span>格式: 日期, 類型, 數值, 備註</span>
            </div>

            <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <div><label class="form-label">年假剩餘</label><input type="number" class="form-input" id="setAL"></div>
                <div><label class="form-label">日工時</label><input type="number" class="form-input" id="setDaily"></div>
            </div>
            <label class="form-label">入職日期</label>
            <input type="date" class="form-input" id="setJoinDate">
            
            <button class="btn btn-primary" onclick="window.app.saveSettings(this)">儲存設定</button>
        </div>
    </div>

    <div class="modal-overlay" id="recModal" onclick="if(event.target===this) window.app.closeModal()">
        <div class="modal-card">
            <h3 id="modalDateTitle" style="margin-top:0">新紀錄</h3>
            <form id="recForm" onsubmit="window.app.saveRecord(event)">
                <input type="hidden" id="editId"><input type="hidden" id="recType" value="OT">
                
                <label class="form-label" style="margin-top:0">日期</label>
                <input type="date" class="form-input" id="inpDate" required onchange="window.app.onModalDateChange(this.value)">

                <div style="display:flex; background:#faf9f7; padding:5px; border-radius:18px; margin:20px 0; border:1px solid var(--line);">
                    <button type="button" id="btnTypeOT" class="btn" style="margin:0; background:white; color:var(--primary-dark); box-shadow:0 2px 8px rgba(0,0,0,0.05);" onclick="window.app.setType('OT')">加班 OT</button>
                    <button type="button" id="btnTypeLeave" class="btn" style="margin:0; background:transparent; color:var(--text-sub); box-shadow:none;" onclick="window.app.setType('Leave')">請假</button>
                </div>
                
                <div id="secOT">
                    <label class="form-label">當日扣除工時 (小時)</label>
                    <div class="std-hours-group">
                        <button type="button" class="std-btn active" id="btnStd9" onclick="window.app.setStdHours(9)">9h (平日)</button>
                        <button type="button" class="std-btn" id="btnStd8" onclick="window.app.setStdHours(8)">8h</button>
                        <button type="button" class="std-btn" id="btnStd4" onclick="window.app.setStdHours(4)">4h (週六)</button>
                        <button type="button" class="std-btn" id="btnStd0" onclick="window.app.setStdHours(0)">0h (假日)</button>
                    </div>
                    <input type="number" id="inpStdVal" value="9" style="display:none;"> 

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div><label class="form-label">上班</label><input type="time" class="form-input" id="inpIn" onchange="window.app.calcOT()"></div>
                        <div><label class="form-label">下班</label><input type="time" class="form-input" id="inpOut" onchange="window.app.calcOT()"></div>
                    </div>
                    <div id="otMsg" style="text-align:right; font-size:0.8rem; color:var(--primary); margin-top:8px; height:1.2em;"></div>
                    <label class="form-label">OT 時數 (自動計算)</label><input type="number" step="0.1" class="form-input" id="inpHours" placeholder="結果">
                </div>

                <div id="secLeave" style="display:none;">
                    <label class="form-label">假別</label>
                    <select class="form-input" id="inpLeaveType"><option value="SL">病假 (SL)</option><option value="AL">年假 (AL)</option></select>
                    <label class="form-label">天數</label><input type="number" step="0.5" class="form-input" id="inpDays" value="1">
                </div>
                <label class="form-label">備註</label><input type="text" class="form-input" id="inpNote">
                <button type="submit" class="btn btn-primary">儲存</button>
                <button type="button" class="btn btn-outline" style="display:none;" id="btnDel" onclick="window.app.delRecord(this)">刪除</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAi_iDY4JeppmveW5-Uq2cMRWJY9jeT9Dw",
            authDomain: "work-life-balance-9f09b.firebaseapp.com",
            projectId: "work-life-balance-9f09b",
            storageBucket: "work-life-balance-9f09b.firebasestorage.app",
            messagingSenderId: "869347289477",
            appId: "1:869347289477:web:c2bee07bc2aeb92973bcec",
            measurementId: "G-94EXTK7W8Y"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "worklife_app", "personal_data_v2");

        let localData = {
            records: [],
            settings: { 
                workMode: "alt_sat", baseSat: "2025-09-13", joinDate: "2024-09-01", 
                holidays: [{date: "2025-01-01", name: "元旦"}], alBalance: 14, dailyHours: 8 
            }
        };
        let selectedDate = new Date();
        let currentViewDate = new Date(); 
        let curType = 'OT';
        let editId = null;

        onSnapshot(docRef, (docSnap) => {
            const loading = document.getElementById('loadingMask');
            const dot = document.getElementById('statusDot');
            if (docSnap.exists()) {
                const data = docSnap.data();
                if(!data.settings.workMode) data.settings.workMode = 'alt_sat';
                if(data.settings.holidays.length && typeof data.settings.holidays[0] === 'string') {
                    data.settings.holidays = data.settings.holidays.map(d => ({date: d, name: '假期'}));
                }
                localData = data;
                dot.className = 'status-dot online';
                refreshApp();
            } else { setDoc(docRef, localData); dot.className = 'status-dot online'; }
            if(loading) { loading.style.opacity = '0'; setTimeout(()=>loading.style.display='none', 500); }
        }, (err) => {
            document.getElementById('statusDot').className = 'status-dot offline';
            document.getElementById('loadingMask').style.display='none';
            console.error(err);
        });

        window.app = {
            openSettings: () => {
                document.getElementById('setModal').classList.add('open');
                const s = localData.settings;
                window.app.setWorkMode(s.workMode || 'alt_sat');
                document.getElementById('setBaseSat').value = s.baseSat || '';
                document.getElementById('setJoinDate').value = s.joinDate || '';
                document.getElementById('setAL').value = s.alBalance;
                document.getElementById('setDaily').value = s.dailyHours;
                renderHolidayList();
            },
            setWorkMode: (mode) => {
                localData.settings.workMode = mode;
                document.getElementById('modeMonFri').className = `toggle-opt ${mode==='mon_fri'?'active':''}`;
                document.getElementById('modeAltSat').className = `toggle-opt ${mode==='alt_sat'?'active':''}`;
                document.getElementById('satSetting').style.display = mode==='alt_sat' ? 'block' : 'none';
            },
            saveSettings: async (btn) => {
                const originalText = btn.innerText;
                btn.innerText = "⏳ 儲存中..."; btn.disabled = true;
                try {
                    const s = localData.settings;
                    s.baseSat = document.getElementById('setBaseSat').value;
                    s.joinDate = document.getElementById('setJoinDate').value;
                    s.alBalance = Number(document.getElementById('setAL').value);
                    s.dailyHours = Number(document.getElementById('setDaily').value);
                    await pushToCloud();
                    document.getElementById('setModal').classList.remove('open');
                    alert("✅ 設定已儲存！");
                } catch(e) { alert("❌ 錯誤：" + e.message); }
                finally { btn.innerText = originalText; btn.disabled = false; }
            },
            importHolidays: (input) => {
                const file = input.files[0]; if(!file) return;
                const r = new FileReader();
                r.onload = (e) => {
                    const lines = e.target.result.split(/\r\n|\n/);
                    let count = 0;
                    lines.forEach((l, idx) => {
                        if(idx === 0 && l.toLowerCase().includes('date')) return;
                        const parts = l.split(',');
                        if(parts.length >= 2) {
                            let d = parts[0].trim().replace(/\//g, '-');
                            const n = parts[1].trim();
                            if(/^\d{4}-\d{2}-\d{2}$/.test(d)) {
                                if(!localData.settings.holidays.some(h=>h.date===d)) {
                                    localData.settings.holidays.push({date: d, name: n}); count++;
                                }
                            }
                        }
                    });
                    renderHolidayList(); alert(`成功匯入 ${count} 個假期`); input.value='';
                }; r.readAsText(file);
            },
            importRecords: (input) => {
                const file = input.files[0]; if(!file) return;
                const r = new FileReader();
                r.onload = async (e) => {
                    const lines = e.target.result.split(/\r\n|\n/);
                    let count = 0;
                    lines.forEach((l, idx) => {
                        if(idx === 0 && l.toLowerCase().includes('date')) return;
                        const parts = l.split(',');
                        if(parts.length >= 3) {
                            let d = parts[0].trim().replace(/\//g, '-');
                            const t = parts[1].trim(); 
                            const v = parts[2].trim();
                            if(/^\d{4}-\d{2}-\d{2}$/.test(d)) {
                                localData.records.push({
                                    id: Date.now()+Math.random(), date: d, type: t,
                                    subType: t==='Leave'?'AL':null, val: v, note: parts[3]?parts[3].trim():''
                                }); count++;
                            }
                        }
                    });
                    await pushToCloud(); alert(`成功匯入 ${count} 筆紀錄`); input.value='';
                }; r.readAsText(file);
            },
            clearHolidays: () => { if(confirm("確定清空？")) { localData.settings.holidays=[]; renderHolidayList(); } },
            deleteHoliday: (d) => { localData.settings.holidays = localData.settings.holidays.filter(h=>h.date!==d); renderHolidayList(); },
            
            triggerAdd: () => openModal(),
            closeModal: () => document.getElementById('recModal').classList.remove('open'),
            switchTab: (t) => {
                document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
                document.getElementById(`tab-${t}`).classList.add('active');
                document.getElementById(`nav-${t}`).classList.add('active');
            },
            setType: (t) => setType(t), 
            setStdHours: (h) => {
                document.getElementById('inpStdVal').value = h;
                document.querySelectorAll('.std-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('btnStd'+h).classList.add('active');
                window.app.calcOT();
            },
            calcOT: () => calcOT(), 
            saveRecord: (e) => saveRecord(e), delRecord: (b) => delRecord(b), selectDate: (d) => selectDate(d),
            
            jumpToDate: (val) => {
                if(!val) return;
                const [y, m] = val.split('-');
                currentViewDate = new Date(y, m - 1, 15);
                generateScroller();
                window.app.selectDate(new Date(y, m - 1, 1));
            },
            onModalDateChange: (val) => {
                if(!val) return;
                const d = new Date(val);
                const status = getDayStatus(d);
                
                // Smart auto-select Logic
                let defaultStd = 9; // Normal Day
                if(status.isOff) defaultStd = 0; // Holiday/Sunday
                else if(status.type === 'WORK_SAT') defaultStd = 4; // Shift Saturday
                
                window.app.setStdHours(defaultStd);
            }
        };

        function renderHolidayList() {
            const list = document.getElementById('holidayListDisplay');
            const sorted = [...localData.settings.holidays].sort((a,b) => a.date.localeCompare(b.date));
            list.innerHTML = sorted.length ? sorted.map(h => `<div class="holiday-item"><span><span class="holiday-date">${h.date}</span><span>${h.name}</span></span><i class="fa-solid fa-trash" style="color:#ef4444;cursor:pointer" onclick="window.app.deleteHoliday('${h.date}')"></i></div>`).join('') : '<div style="text-align:center;color:#ccc;font-size:0.8rem">無假期資料</div>';
        }

        async function pushToCloud() { await setDoc(docRef, localData); }

        function getDayStatus(d) {
            const dStr = d.toISOString().split('T')[0];
            const s = localData.settings;
            const hol = s.holidays.find(h=>h.date===dStr);
            if(hol) return { type: 'HOLIDAY', name: hol.name, isOff: true };
            if(d.getDay()===0) return { type: 'OFF', name: '週日', isOff: true };
            if(d.getDay()===6) {
                if(s.workMode==='mon_fri') return { type: 'OFF', name: '週六(休)', isOff: true };
                if(!s.baseSat) return { type: 'OFF', name: '週六', isOff: true }; 
                const base = new Date(s.baseSat); const target = new Date(dStr);
                if(target < base) return { type: 'OFF', name: '週六', isOff: true };
                
                let cnt = 0, curr = new Date(base);
                while(curr <= target) {
                    const cStr = curr.toISOString().split('T')[0];
                    if(!s.holidays.some(h=>h.date===cStr)) { if(cStr===dStr) break; cnt++; }
                    curr.setDate(curr.getDate()+7);
                }
                return (cnt%2===0) ? { type: 'WORK_SAT', name: '長週上班', isOff: false } : { type: 'OFF_SAT', name: '短週休假', isOff: true };
            }
            return { type: 'WORK', name: '工作日', isOff: false };
        }

        function refreshApp() {
            const dStr = selectedDate.toISOString().split('T')[0];
            const status = getDayStatus(selectedDate);
            const badge = status.isOff ? (status.type==='HOLIDAY' ? `<span style="background:#fff1f2;color:#e11d48;padding:2px 6px;border-radius:6px;font-size:0.7rem">${status.name}</span>` : `<span style="background:#e6f0e6;color:#5d7a5f;padding:2px 6px;border-radius:6px;font-size:0.7rem">休假</span>`) : `<span style="background:#fff7ed;color:#c2410c;padding:2px 6px;border-radius:6px;font-size:0.7rem">上班</span>`;
            document.getElementById('dateTitleLabel').innerHTML = `${dStr} ${badge}`;
            const recs = localData.records.filter(r => r.date === dStr);
            document.getElementById('dayRecords').innerHTML = recs.length ? recs.map(renderItem).join('') : `<div style="text-align:center;padding:30px;color:#ccc;background:#faf9f7;border-radius:16px;border:1px solid #eee"><div style="font-size:0.9rem">無紀錄</div></div>`;
            updateStats(); renderAllLogs(); generateScroller();
        }

        function renderAllLogs() {
            const sorted = [...localData.records].sort((a,b) => new Date(b.date) - new Date(a.date));
            document.getElementById('fullList').innerHTML = sorted.map(renderItem).join('');
        }
        function renderItem(r) {
            const isOT = r.type === 'OT';
            return `<div class="log-item" onclick="window.appSelectRecord(${r.id})"><div class="log-icon ${isOT?'icon-ot':'icon-leave'}"><i class="fa-solid ${isOT?'fa-clock':'fa-mug-hot'}"></i></div><div class="log-main"><div class="log-title">${isOT?'OT 加班' : r.subType}</div><div class="log-date">${r.date} ${r.note?'· '+r.note:''}</div></div><div class="log-val">${isOT ? '+'+r.val+'h' : '-'+r.val+'天'}</div></div>`;
        }
        window.appSelectRecord = (id) => { const r = localData.records.find(item => item.id === id); if(r) openModal(r); };

        function updateStats() {
            const s = localData.settings;
            const joinD = s.joinDate ? new Date(s.joinDate) : new Date(); 
            const now = new Date();
            let months = (now.getFullYear() - joinD.getFullYear()) * 12 + (now.getMonth() - joinD.getMonth());
            if(now.getDate() < joinD.getDate()) months--;
            const sl = Math.max(0, months * 2) - localData.records.filter(r=>r.type==='Leave'&&r.subType==='SL').reduce((a,b)=>a+Number(b.val),0);
            const ot = localData.records.filter(r=>r.type==='OT').reduce((a,b)=>a+Number(b.val),0);
            const al = s.alBalance - localData.records.filter(r=>r.type==='Leave'&&r.subType==='AL').reduce((a,b)=>a+Number(b.val),0);
            document.getElementById('dispSL').innerText = sl; document.getElementById('dispOT').innerText = ot.toFixed(1);
            document.getElementById('dispOTDays').innerText = (ot/(s.dailyHours||8)).toFixed(1); document.getElementById('dispAL').innerText = al;
        }

        function generateScroller() {
            const el = document.getElementById('dateScroller'); el.innerHTML = '';
            const start = new Date(currentViewDate); 
            start.setDate(start.getDate() - 15);
            
            for(let i=0; i<60; i++) {
                const d = new Date(start); d.setDate(start.getDate() + i);
                const dStr = d.toISOString().split('T')[0];
                const status = getDayStatus(d);
                const isSel = dStr === selectedDate.toISOString().split('T')[0];
                const hasData = localData.records.some(r => r.date === dStr);
                const chip = document.createElement('div');
                chip.className = `date-chip ${isSel?'active':''} ${hasData?'has-data':''} ${status.type==='HOLIDAY'?'is-holiday':''}`;
                chip.onclick = () => selectDate(d);
                chip.innerHTML = `<span>${['日','一','二','三','四','五','六'][d.getDay()]}</span><span>${d.getDate()}</span><div class="has-data-dot"></div>`;
                el.appendChild(chip);
            }
            
            setTimeout(()=> {
                const chip = Array.from(document.querySelectorAll('.date-chip')).find(el => el.innerHTML.includes(selectedDate.getDate()));
                if(chip && selectedDate.getMonth() === currentViewDate.getMonth()) chip.scrollIntoView({inline:'center'});
            }, 100);
        }
        function selectDate(d) { selectedDate = d; refreshApp(); }
        
        function openModal(r = null) {
            document.getElementById('recModal').classList.add('open');
            const dStr = selectedDate.toISOString().split('T')[0];
            document.getElementById('inpDate').value = dStr;
            window.app.onModalDateChange(dStr); // Trigger auto-select logic on open

            if(r) { 
                editId=r.id; 
                document.getElementById('inpDate').value = r.date;
                document.getElementById('inpNote').value=r.note||''; 
                setType(r.type); 
                if(r.type==='OT') document.getElementById('inpHours').value=r.val; 
                else{ document.getElementById('inpLeaveType').value=r.subType; document.getElementById('inpDays').value=r.val; } 
                document.getElementById('btnDel').style.display='block'; 
                
                // For existing records, we might want to guess standard hours or just leave it at 9?
                // Re-triggering date change logic is safer to get defaults correct
                window.app.onModalDateChange(r.date);
            } else { 
                editId=null; 
                document.getElementById('recForm').reset(); 
                document.getElementById('inpDate').value = dStr;
                setType('OT'); 
                document.getElementById('btnDel').style.display='none';
                window.app.onModalDateChange(dStr);
            }
        }
        
        function setType(t) { curType = t; document.getElementById('recType').value = t; document.getElementById('secOT').style.display = t==='OT'?'block':'none'; document.getElementById('secLeave').style.display = t==='Leave'?'block':'none'; }
        
        function calcOT() {
            const i=document.getElementById('inpIn').value;
            const o=document.getElementById('inpOut').value;
            if(!i||!o) return;
            
            const mi = i.split(':').reduce((h,m)=>h*60+Number(m),0);
            const mo = o.split(':').reduce((h,m)=>h*60+Number(m),0);
            const stdHours = Number(document.getElementById('inpStdVal').value);
            
            let durationMins = mo - mi;
            if(durationMins < 0) durationMins += 24*60; 

            const otMins = Math.max(0, durationMins - (stdHours * 60));
            
            document.getElementById('inpHours').value = (otMins / 60).toFixed(1);
            document.getElementById('otMsg').innerText = `總工時 ${(durationMins/60).toFixed(1)}h - 扣除 ${stdHours}h`;
        }
        
        async function saveRecord(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.innerText = "⏳ 儲存中..."; btn.disabled = true;
            try {
                const dateVal = document.getElementById('inpDate').value;
                if(!dateVal) throw new Error("請選擇日期");

                const val = curType==='OT' ? document.getElementById('inpHours').value : document.getElementById('inpDays').value;
                if(!val) throw new Error("請輸入數值");
                
                const rec = { id: editId||Date.now(), date: dateVal, type: curType, subType: curType==='Leave'?document.getElementById('inpLeaveType').value:null, val: val, note: document.getElementById('inpNote').value };
                
                if(editId) localData.records = localData.records.filter(r=>r.id!==editId);
                localData.records.push(rec); 
                
                await pushToCloud(); 
                alert("✅ 儲存成功！"); 
                window.app.closeModal();
                
                const [y, m, d] = dateVal.split('-');
                currentViewDate = new Date(y, m-1, 15); 
                generateScroller();
                window.app.selectDate(new Date(y, m-1, d)); 

            } catch(err) { alert("❌ 錯誤：" + err.message); }
            finally { btn.innerText = originalText; btn.disabled = false; }
        }
        
        async function delRecord(btn) { 
            if(editId && confirm("確定刪除此紀錄？")) { 
                btn.innerText = "刪除中...";
                try { localData.records = localData.records.filter(r=>r.id!==editId); await pushToCloud(); window.app.closeModal(); } 
                catch(e){ alert("刪除失敗"); btn.innerText="刪除"; }
            } 
        }
        
        setTimeout(()=> {
            const chip = Array.from(document.querySelectorAll('.date-chip')).find(el => el.innerHTML.includes(selectedDate.getDate()));
            if(chip) chip.scrollIntoView({inline:'center'});
        }, 500);
    </script>
</body>
</html>
